{% if page.video_url %}
<center><video id="videoplayer" controls></video></center>
  <script>
    var videoUrl = "{{ page.video_url }}";
    var videoPlayer = dashjs.MediaPlayer().create();
    videoPlayer.initialize(document.querySelector("#videoplayer"), videoUrl, true);
    videoPlayer.setAutoPlay(false);
  </script>
{% else %}
<script src="{{ site.url  }}{{ site.baseurl  }}{{ site.assets_path  }}/js/vibrant.js"></script>
<div id="player_msg"><i class="fa fa-cog fa-spin fa-3x fa-fw"></i> LOADING SONICS</div>
<div id="player"></div>
<div id="player_controls">
  <div id="music_dur"></div>
  <button id="audioBtnPlay" onclick="wavesurfer.play()">
    <i class="fa fa-play" aria-hidden="true"></i>
  </button>
  <button id="audioBtnPause" onclick="wavesurfer.pause()">
    <i class="fa fa-pause" aria-hidden="true"></i>
  </button>
  <button id="toggleMuteBtn" onclick="wavesurfer.toggleMute()">Toggle Mute</button>
  {% if page.bin_url %}
    <button id="toggleBinBtn" onclick="toggleBin()">Toggle Stereo/Binaural</button>
  {% endif %}
  <!-- <canvas id="oscilloscope" width="400" height="100" style="vertical-align:center;float:right"></canvas> -->
</div>
 <script>
   var cover = "{{ page.cover }}"
   var url = "{{ page.stream_url }}"

   
   var dur = 0.0;

   var v = new Vibrant("https:" + cover);

   var wavesurfer = WaveSurfer.create({
     container: "#player",
     cursorWidth: 2,
   });

   // var audioCtx = new(window.AudioContext || window.webkitAudioContext)();
   var audioCtx = wavesurfer.backend.ac;
   var analyser = audioCtx.createAnalyser();

   analyser.fftSize = 2048;

   var bufferLength = analyser.frequencyBinCount;
   var dataArray = new Uint8Array(bufferLength);
   analyser.getByteTimeDomainData(dataArray);

	// var canvas = document.getElementById("oscilloscope");
	var canvas = document.getElementById("c");

	var canvasCtx = canvas.getContext("2d");
  
  function shuffle(a) {
      for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
  }

  var lineWidth = 2;
  var drawColors = shuffle(colors)
  var widthDelta = 0;
  var alpha = 1.0;
  console.log(drawColors)

	// draw an oscilloscope of the current audio source

	function draw() {

		requestAnimationFrame(draw);

		analyser.getByteTimeDomainData(dataArray);

    
    canvasCtx.fillStyle = `rgb(0, 0, 0, ${alpha})`;
		canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
    
		canvasCtx.lineWidth = lineWidth;
    canvasCtx.strokeStyle = drawColors[0];
		// canvasCtx.strokeStyle = "rgb(200, 200, 200)";

		canvasCtx.beginPath();

		var sliceWidth = canvas.width * 1.0 / bufferLength;
		var x = 0;

		for (var i = 0; i < bufferLength; i++) {

			var v = dataArray[i] / 128.0;
			var y = v * canvas.height / 2;

			if (i === 0) {
				canvasCtx.moveTo(x, y);
        if (lineWidth > 5) {
          drawColors = shuffle(drawColors)
        }
			} else {
				canvasCtx.lineTo(x, y);
        widthDelta = shuffle([0.001, -0.0001, -1, 0.27, 0.02, 0.1, 0.0000001, 0.00001, -0.000001, -0.000001])[0];
        if (lineWidth > 0) {
          lineWidth += widthDelta
        } else {
          lineWidth = 2;
          alpha += shuffle([-0.1, 0.1, 1.0])[0];
        }
			}

			x += sliceWidth;
		}

    if (lineWidth > 100.0) {
      lineWidth = 1.0;
      alpha = shuffle([0.5, 0.005, 0.0008])[2];
    }

    if (alpha > 1) {
      alpha = shuffle([0.1, 0.001, 0.0001])[0];
    } 

		canvasCtx.lineTo(canvas.width, canvas.height / 2);
		canvasCtx.stroke();
	}




   wavesurfer.backend.setFilter(analyser);

   wavesurfer.on('ready', function () {
         document.getElementById("player_msg").innerHTML = "";
         draw();
         wavesurfer.play();
         dur = wavesurfer.getDuration().toFixed(2);
         document.getElementById("music_dur").innerHTML = `<i class="fa fa-clock-o" aria-hidden="true"></i> ${dur}`;
   });

   wavesurfer.load(`//${url}`);

   v.getPalette((err, palette) => {
     if (err) {
       console.log(err)
     }

     var muted = !err ? palette.Muted ? palette.Muted.getHex() : null : null;
     var vibrant = !err ? palette.Vibrant ? palette.Vibrant.getHex() : null : null;
     var darkVibrant = !err ? palette.DarkVibrant ? palette.DarkVibrant.getHex() : null : null;

     wavesurfer.setWaveColor(vibrant || "#999");
     wavesurfer.setProgressColor(muted || "#555");
     wavesurfer.setCursorColor(darkVibrant || "#333");

     colors.push(darkVibrant, vibrant, muted);
   })

   wavesurfer.on('seek', () => {
     alpha = 0.0001;
   })

   function toggleBin() {
     var stUrl = "{{ page.stream_url }}";
     var binUrl = "{{ page.bin_url }}";
     url = url == stUrl ? binUrl : stUrl
     wavesurfer.load(`//${url}`);
   }

 </script>
 {% endif %}
